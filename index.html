<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple Billing / Invoice</title>
  <style>
    :root{--bg:#f7fafc;--card:#fff;--accent:#0ea5a4;--muted:#6b7280}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Arial}
    body{margin:0;background:var(--bg);color:#0f172a}
    header{background:linear-gradient(90deg,#06b6d4, #7dd3fc);padding:18px;color:white}
    .container{max-width:1100px;margin:18px auto;padding:12px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    h2{margin:0 0 10px 0}
    label{display:block;margin:8px 0 4px;font-size:13px;color:var(--muted)}
    input[type="text"],input[type="number"],select,textarea{width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px dashed #eef2f7;text-align:left}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .invoice{padding:18px}
    .row{display:flex;gap:8px}
    .flex{display:flex;gap:8px}
    .right{text-align:right}
    .small{font-size:13px;color:var(--muted)}
    .product-list{max-height:220px;overflow:auto}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}.container{padding:8px}}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 style="margin:0;font-size:20px">Billing / Invoice Generator (Single file)</h1>
      <div class="small">Add products, set tax/discount, accept advance payments — save invoice history by mobile & invoice number.</div>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <div class="card">
        <h2>Customer & Products</h2>

        <label>Customer Name</label>
        <input id="customerName" placeholder="Enter customer name" />
        <label>Mobile Number</label>
        <input id="customerMobile" placeholder="10-digit mobile" />
        <div class="small" style="margin-bottom:8px">When you save an invoice it will be stored against this mobile number.</div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
          <input id="search" placeholder="Search products..." style="flex:1;padding:8px;border:1px solid #e6e9ef;border-radius:8px"/>
          <button class="btn" onclick="showAddProduct()">+ Add product</button>
        </div>

        <div class="card product-list" id="productCatalog"></div>

        <h3 style="margin-top:14px">Cart</h3>
        <table id="cartTable">
          <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th class="right">Total</th><th></th></tr></thead>
          <tbody></tbody>
        </table>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div class="muted">Invoice No.: <strong id="invoiceNo"></strong></div>
          <div class="actions">
            <button class="btn" onclick="clearCart()">Clear</button>
            <button class="btn" onclick="printInvoice()">Print / Save PDF</button>
            <button class="btn" onclick="exportInvoice()">Export JSON</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Advance Payment (₹):</label>
          <input id="advanceInput" type="number" min="0" value="0" oninput="onAdvanceChange()"/>
          <div class="small">Enter amount received as advance — invoice balance auto-updates.</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" onclick="saveInvoice()">Save Invoice</button>
          <button class="btn" onclick="openHistory()">Open History</button>
        </div>

      </div>

      <div class="card">
        <h2>Invoice Preview</h2>
        <div class="invoice" id="invoicePreview">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 style="margin:0">Your Shop Name</h3>
              <div class="small">Address line 1<br/>City, State</div>
            </div>
            <div class="right small">
              <div>Invoice: <strong id="previewInv"></strong></div>
              <div>Date: <span id="previewDate"></span></div>
              <div class="small">Customer: <span id="previewCustomer"></span></div>
            </div>
          </div>

          <hr style="margin:12px 0">
          <div id="lineItems"></div>

          <div style="display:flex;justify-content:flex-end;margin-top:12px">
            <div style="width:360px">
              <div class="row small"><div style="flex:1">Sub total</div><div id="subTotal" style="width:120px;text-align:right"></div></div>
              <div class="row small"><div style="flex:1">Discount</div><div id="discountVal" style="width:120px;text-align:right">0.00</div></div>
              <div class="row small"><div style="flex:1">Tax</div><div id="taxVal" style="width:120px;text-align:right">0.00</div></div>
              <div class="row small"><div style="flex:1">Total</div><div id="totalVal" style="width:120px;text-align:right"></div></div>
              <div class="row small"><div style="flex:1">Advance Paid</div><div id="advanceVal" style="width:120px;text-align:right">0.00</div></div>
              <div style="height:8px"></div>
              <div class="row" style="font-weight:700;font-size:18px"><div style="flex:1">Balance Due</div><div id="balanceVal" style="width:120px;text-align:right"></div></div>
            </div>
          </div>
        </div>

        <hr>
        <h3>Settings</h3>
        <label>Discount (₹ or %):</label>
        <div style="display:flex;gap:8px"><input id="discount" placeholder="0"/><select id="discountType"><option value="flat">₹ Flat</option><option value="percent">% Percent</option></select></div>
        <label>Tax (%):</label>
        <input id="tax" value="0"/>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" onclick="applySettings()">Apply</button>
          <button class="btn" onclick="randomizeInvoice()">New Invoice No.</button>
        </div>

        <div style="margin-top:12px" class="small">Tip: change advance in the left panel or edit it here and click Apply — balance updates automatically.</div>
      </div>
    </div>
  </div>

  <!-- Hidden add product modal (simple) -->
  <div id="modal" style="position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center">
    <div style="width:420px;background:white;border-radius:10px;padding:16px">
      <h3 style="margin-top:0">Add Product</h3>
      <label>Name</label><input id="p_name" />
      <label>Price</label><input id="p_price" type="number" />
      <label>SKU (optional)</label><input id="p_sku" />
      <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn" onclick="saveProduct()">Save</button>
      </div>
    </div>
  </div>

  <!-- History modal -->
  <div id="historyModal" style="position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:flex-start;justify-content:center;padding-top:40px;overflow:auto">
    <div style="width:920px;max-width:96%;background:white;border-radius:10px;padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Invoice History</h3>
        <div><button class="btn" onclick="closeHistory()">Close</button></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <input id="historyMobile" placeholder="Search by mobile number" />
        <input id="historyInvoiceNo" placeholder="Search by invoice no" />
        <button class="btn" onclick="searchHistory()">Search</button>
        <button class="btn" onclick="listAllHistory()">List All</button>
        <div class="small" style="margin-left:auto">Data stored locally in your browser (localStorage).</div>
      </div>

      <div id="historyResults" style="margin-top:12px;max-height:520px;overflow:auto"></div>
    </div>
  </div>

<script>
// Simple single-file billing app with advance payment, local storage history, and customer mobile lookup
let products = [
  {id:1,name:'Product A',price:199.00,sku:'A001'},
  {id:2,name:'Product B',price:349.00,sku:'B001'},
  {id:3,name:'Service X',price:499.00,sku:'S100'}
];
let cart = [];
let settings = {discount:0,discountType:'flat',tax:0,advance:0};

function $(id){return document.getElementById(id)}

function renderCatalog(filter=''){
  const el = $('productCatalog');el.innerHTML='';
  const list = products.filter(p=>p.name.toLowerCase().includes(filter.toLowerCase())|| (p.sku||'').toLowerCase().includes(filter.toLowerCase()));
  list.forEach(p=>{
    const d = document.createElement('div');
    d.style.padding='8px';d.style.borderBottom='1px solid #f1f5f9';
    d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${p.name}</strong><div class='small'>₹ ${p.price.toFixed(2)} ${p.sku? (' • '+p.sku):''}</div></div><div><button class='btn' onclick='addToCart(${p.id})'>Add</button></div></div>`;
    el.appendChild(d);
  });
}

function renderCart(){
  const tbody = $('cartTable').querySelector('tbody');tbody.innerHTML='';
  cart.forEach((it,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.name}</td><td><input type='number' min='1' value='${it.qty}' style='width:72px' onchange='updateQty(${idx}, this.value)' /></td><td>₹ ${it.price.toFixed(2)}</td><td class='right'>₹ ${(it.price*it.qty).toFixed(2)}</td><td><button onclick='removeItem(${idx})' class='btn'>Remove</button></td>`;
    tbody.appendChild(tr);
  });
  renderPreview();
}

function addToCart(id){
  const p = products.find(x=>x.id===id); if(!p) return;
  const existing = cart.find(x=>x.id===id);
  if(existing) existing.qty +=1; else cart.push({...p,qty:1});
  renderCart();
}
function updateQty(i,val){ cart[i].qty = Math.max(1, Number(val)); renderCart(); }
function removeItem(i){ cart.splice(i,1); renderCart(); }
function clearCart(){ cart=[]; renderCart(); }

function computeTotals(){
  let subtotal = 0;
  cart.forEach(it=> subtotal += it.price*it.qty);
  let discount = Number(settings.discount)||0;
  if(settings.discountType==='percent') discount = subtotal * (discount/100);
  let taxable = subtotal - discount;
  let tax = taxable * ((Number(settings.tax)||0)/100);
  const total = subtotal - discount + tax;
  const advance = Number(settings.advance)||0;
  let balance = total - advance; if(balance < 0) balance = 0;
  return {subtotal,discount,tax,total,advance,balance};
}

function renderPreview(){
  $('previewDate').innerText = new Date().toLocaleString();
  $('previewInv').innerText = $('invoiceNo').innerText;
  const customer = $('customerName').value.trim() + ( $('customerMobile').value.trim() ? (' • ' + $('customerMobile').value.trim()) : '');
  $('previewCustomer').innerText = customer || '-';

  const li = $('lineItems'); li.innerHTML='';
  cart.forEach(it=>{
    const row = document.createElement('div');
    row.style.display='flex';row.style.justifyContent='space-between';row.style.padding='6px 0';
    const left = document.createElement('div');left.innerHTML = `<strong>${it.name}</strong><div class='small'>Qty: ${it.qty} • ₹ ${it.price.toFixed(2)}</div>`;
    const right = document.createElement('div'); right.innerHTML = `₹ ${(it.price*it.qty).toFixed(2)}`;
    row.appendChild(left);row.appendChild(right);li.appendChild(row);
  });

  const t = computeTotals();
  $('subTotal').innerText = '₹ '+t.subtotal.toFixed(2);
  $('discountVal').innerText = '₹ '+t.discount.toFixed(2);
  $('taxVal').innerText = '₹ '+t.tax.toFixed(2);
  $('totalVal').innerText = '₹ '+t.total.toFixed(2);
  $('advanceVal').innerText = '₹ '+t.advance.toFixed(2);
  $('balanceVal').innerText = '₹ '+t.balance.toFixed(2);
}

function showAddProduct(){ $('modal').style.display='flex'; }
function closeModal(){ $('modal').style.display='none'; $('p_name').value='';$('p_price').value='';$('p_sku').value=''; }
function saveProduct(){
  const name = $('p_name').value.trim(); const price = Number($('p_price').value)||0; const sku = $('p_sku').value.trim();
  if(!name || price<=0){ alert('Enter product name and price > 0'); return; }
  const id = products.length? (Math.max(...products.map(p=>p.id))+1):1;
  products.push({id,name,price,sku}); closeModal(); renderCatalog();
}

function applySettings(){ settings.discount = Number($('discount').value)||0; settings.discountType = $('discountType').value; settings.tax = Number($('tax').value)||0; settings.advance = Number($('advanceInput').value)||0; renderPreview(); }

function onAdvanceChange(){ settings.advance = Number($('advanceInput').value)||0; renderPreview(); }

// Local storage helpers
function loadInvoices(){
  try{ return JSON.parse(localStorage.getItem('invoices_v1')||'[]'); }catch(e){ return []; }
}
function saveInvoices(arr){ localStorage.setItem('invoices_v1', JSON.stringify(arr)); }

function saveInvoice(){
  const mobile = $('customerMobile').value.trim();
  const name = $('customerName').value.trim();
  if(!mobile){ if(!confirm('Save without customer mobile? This invoice will not be associated with a customer. Continue?')) return; }
  const invNo = $('invoiceNo').innerText || ('INV'+Date.now().toString().slice(-8));
  const t = computeTotals();
  const record = {
    invoiceNo: invNo,
    date: new Date().toISOString(),
    customer: {name, mobile},
    products: cart.map(p=>({id:p.id,name:p.name,price:p.price,qty:p.qty,sku:p.sku})),
    settings: {...settings, discount: Number(settings.discount)||0, tax: Number(settings.tax)||0, advance: Number(settings.advance)||0},
    totals: t
  };
  let arr = loadInvoices();
  // replace if same invoiceNo
  const existingIndex = arr.findIndex(x=>x.invoiceNo === invNo);
  if(existingIndex>=0) arr[existingIndex] = record; else arr.unshift(record);
  saveInvoices(arr);
  // also save customer quicklist
  if(mobile){
    const customers = loadCustomers();
    customers[mobile] = {name, mobile, lastInvoice: invNo, lastSeen: new Date().toISOString()};
    saveCustomers(customers);
  }
  alert('Invoice saved locally.');
}

function loadCustomers(){ try{ return JSON.parse(localStorage.getItem('customers_v1')||'{}'); }catch(e){ return {}; } }
function saveCustomers(obj){ localStorage.setItem('customers_v1', JSON.stringify(obj)); }

function openHistory(){ $('historyModal').style.display='flex'; listAllHistory(); }
function closeHistory(){ $('historyModal').style.display='none'; }

function listAllHistory(){ const arr = loadInvoices(); renderHistoryResults(arr); }

function searchHistory(){ const mobile = $('historyMobile').value.trim(); const inv = $('historyInvoiceNo').value.trim(); const arr = loadInvoices(); let results = arr;
  if(mobile) results = results.filter(r=>r.customer && r.customer.mobile && r.customer.mobile.includes(mobile));
  if(inv) results = results.filter(r=>r.invoiceNo && r.invoiceNo.includes(inv));
  renderHistoryResults(results);
}

function renderHistoryResults(results){
  const el = $('historyResults'); el.innerHTML='';
  if(!results.length){ el.innerHTML = '<div class="small">No invoices found.</div>'; return; }
  results.forEach(r=>{
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9';
    d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${r.invoiceNo}</strong> <span class='small'>• ${new Date(r.date).toLocaleString()}</span><div class='small'>${r.customer && r.customer.name ? r.customer.name+' • '+r.customer.mobile : 'No customer' }</div></div><div style='display:flex;gap:8px'><button class='btn' onclick='loadInvoice(\"${r.invoiceNo}\")'>Load</button><button class='btn' onclick='downloadInvoice(\"${r.invoiceNo}\")'>Download</button><button class='btn' onclick='deleteInvoice(\"${r.invoiceNo}\")'>Delete</button></div></div>`;
    el.appendChild(d);
  });
}

function loadInvoice(invNo){ const arr = loadInvoices(); const r = arr.find(x=>x.invoiceNo===invNo); if(!r){ alert('Invoice not found'); return; }
  // restore
  cart = r.products.map(p=>({id:p.id,name:p.name,price:p.price,qty:p.qty,sku:p.sku}));
  settings.discount = r.settings.discount||0; settings.discountType = r.settings.discountType||'flat'; settings.tax = r.settings.tax||0; settings.advance = r.settings.advance||0;
  $('discount').value = settings.discount; $('discountType').value = settings.discountType; $('tax').value = settings.tax; $('advanceInput').value = settings.advance;
  $('customerName').value = (r.customer && r.customer.name) || ''; $('customerMobile').value = (r.customer && r.customer.mobile) || '';
  $('invoiceNo').innerText = r.invoiceNo; renderCart(); closeHistory(); alert('Invoice loaded into editor.');
}

function downloadInvoice(invNo){ const arr = loadInvoices(); const r = arr.find(x=>x.invoiceNo===invNo); if(!r) return alert('Not found'); const blob = new Blob([JSON.stringify(r,null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `invoice-${invNo}.json`; a.click(); }

function deleteInvoice(invNo){ if(!confirm('Delete invoice '+invNo+'? This cannot be undone.')) return; let arr = loadInvoices(); arr = arr.filter(x=>x.invoiceNo!==invNo); saveInvoices(arr); listAllHistory(); }

function exportInvoice(){
  const data = {invoiceNo: $('invoiceNo').innerText, date: new Date().toISOString(), customer:{name: $('customerName').value.trim(), mobile: $('customerMobile').value.trim()}, products: cart, settings};
  const blob = new Blob([JSON.stringify(data, null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `invoice-${$('invoiceNo').innerText||'untitled'}.json`; a.click();
}

function printInvoice(){
  // Print only the invoicePreview area with styling
  const content = document.getElementById('invoicePreview').outerHTML;
  // Gather minimal styles to make the printed invoice look like the preview
  const styles = `
    <style>
      @media print { @page{ size: auto; margin: 10mm; } }
      body{font-family:Inter, Arial, sans-serif; color:#0f172a; margin:12px}
      .invoice{padding:0}
      h3{margin:0}
      .small{font-size:13px;color:#6b7280}
      .row{display:flex;gap:8px}
      .right{text-align:right}
      /* Ensure table-like spacing for line items */
      #lineItems{margin-top:8px}
      #lineItems > div{display:flex;justify-content:space-between;padding:6px 0}
      .no-print{display:none}
    </style>
  `;

  const win = window.open('','_blank');
  const title = document.getElementById('invoiceNo').innerText || 'Invoice';
  win.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title>${styles}</head><body>${content}</body></html>`);
  win.document.close();
  // Wait a tick to allow rendering, then print
  win.focus();
  win.onload = function(){
    setTimeout(()=>{ win.print(); }, 100);
  };
}

function randomizeInvoice(){ const n = 'INV'+Date.now().toString().slice(-8); $('invoiceNo').innerText=n; $('previewInv').innerText=n; }

function init(){ renderCatalog(); renderCart(); randomizeInvoice(); $('search').addEventListener('input', e=>renderCatalog(e.target.value)); $('advanceInput').addEventListener('input', onAdvanceChange); }

init();
</script>
</body>
</html>
